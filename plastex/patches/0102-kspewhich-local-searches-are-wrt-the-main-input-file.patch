From 5247a1ab39b3899d950b9fdc93988f4955f45ef3 Mon Sep 17 00:00:00 2001
From: "Andrea C. G. Mennucci" <andrea.mennucci@gmail.com>
Date: Mon, 21 Feb 2022 19:02:02 +0100
Subject: [PATCH 102/103] kspewhich: local searches are wrt the main input
 filename

---
 plasTeX/TeX.py | 13 ++++++-------
 1 file changed, 6 insertions(+), 7 deletions(-)

diff --git a/plasTeX/TeX.py b/plasTeX/TeX.py
index f40316f..89e5b8f 100644
--- a/plasTeX/TeX.py
+++ b/plasTeX/TeX.py
@@ -1335,13 +1335,12 @@ class TeX(object):
         # When, for example, ``\Input{name}`` is encountered, we should look in
         # the directory containing the file being processed. So the following
         # code adds the directory to the start of $TEXINPUTS.
-        TEXINPUTS = None
-        try:
-            srcDir = os.path.dirname(self.filename)
-        except AttributeError:
-            # I think this happens only for the command line file.
-            pass
-        else:
+        #
+        TEXINPUTS = srcDir = None
+        
+        srcDir = None if self.main_input_file is None else  os.path.dirname(self.main_input_file)
+
+        if srcDir is not None:
             TEXINPUTS = os.environ.get("TEXINPUTS",'')
             os.environ["TEXINPUTS"] = "%s%s%s%s" % (srcDir, os.path.pathsep, TEXINPUTS, os.path.pathsep)
 
-- 
2.32.0

