{% load static %}
{% load i18n %}
<script>
var blob_md5="{{blob_md5}}"; var blob_mtime="{{blob_mtime}}";
{% if BLOB %}
  const get_blob_md5_url = "{% url 'UUID:md5' NICK=NICK UUID=UUID ACCESS="undefined" FILE=BLOB %}";
{% else %}
  const get_blob_md5_url = "";
{% endif %}
var      compilation_in_progress = {{ compilation_in_progress }};
const    ajax_views_url = "{{ ajax_views_url }}";
if ( compilation_in_progress ) { 
   window.addEventListener('load', ajax_views_post );
}; 
</script>

{% if USE_CODEMIRROR %}
<script> const use_CodeMirror = true; </script>
<link href="{% static 'UUID/cm/lib/codemirror.css' %}" rel="stylesheet">
<link href="{% static 'UUID/cm/addon/dialog/dialog.css' %}" rel="stylesheet">
<link href="{% static 'UUID/cm/addon/search/matchesonscrollbar.css' %}" rel="stylesheet">
<link href="{% static 'UUID/cm/addon/scroll/simplescrollbars.css' %}" rel="stylesheet">
<style>
      .breakpoints {width: .8em;}
      .breakpoint { color: #822; }
      .CodeMirror {border: 1px solid #aaa;}
      .cm-trailingspace {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAYAAAB/qH1jAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QUXCToH00Y1UgAAACFJREFUCNdjPMDBUc/AwNDAAAFMTAwMDA0OP34wQgX/AQBYgwYEx4f9lQAAAABJRU5ErkJggg==);
        background-position: bottom left;
        background-repeat: repeat-x;
      }
</style>
    
<script src="{% static 'UUID/cm/lib/codemirror.js' %}"></script>

<script src="{% static 'UUID/cm/mode/stex/stex.js' %}"></script>

<script src="{% static 'UUID/cm/addon/scroll/simplescrollbars.js' %}"></script>

<script src="{% static 'UUID/cm/addon/dialog/dialog.js' %}"></script>
<script src="{% static 'UUID/cm/addon/search/searchcursor.js' %}"></script>
<script src="{% static 'UUID/cm/addon/search/search.js' %}"></script>

<script src="{% static 'UUID/cm/addon/edit/matchbrackets.js' %}"></script>
<script src="{% static 'UUID/cm/addon/edit/trailingspace.js' %}"></script>

<script src="{% static 'UUID/cm/addon/scroll/annotatescrollbar.js' %}"></script>
<script src="{% static 'UUID/cm/addon/search/matchesonscrollbar.js' %}"></script>
<script src="{% static 'UUID/cm/addon/search/jump-to-line.js' %}"></script>






{% include "CodeMirrorHelp.html" %}

{% else %}
<script> const use_CodeMirror = false; </script>
{% endif %}

<form action="{% url 'UUID:postedit' NICK=NICK UUID=UUID %}" id="{{ blobeditform.htmlid }}" method="post" class="w-100">
         <div id="{{ blobeditform.htmlid }}_topdiv" class="bg-warning" style="display: none;">{% translate 'This content is open in another tab: do not edit here' %}</div>
        {% csrf_token %}{{ blobeditform.non_field_errors }}
        {% for field in blobeditform %} {% if field.is_hidden %}  {{ field }}
        {% elif not field.name in blobform_filters %}
         <div class="form-group w-100" id="id_div_blobeditform_{{field.name}}"  >
          {{ field.errors }}    {{ field.label_tag }} {{ field }}
          {% if field.help_text %}
            <small class="font-italic">{{ field.help_text|safe }}</small>
          {% endif %}
         </div>
        {% endif %}{% endfor %}
        <input type="submit" class="btn {{ compile_button_class }}"
         data-toggle="tooltip" title="Save changes, update PDF and HTML"
         onclick="update_editform();  if ( check_primary_tab() ) { prevent_unload_remove (); blob_post('compile_no_reload'); }; return false;"
         id="id_blobeditform_compile" name="compile" value="Compile">
        
        <img id="id_network_error" class="btn-danger"
             data-toggle="tooltip" title="{% translate 'There was a network error' %}"
             style="display: none;"
             src="{% static 'ColDoc/sync_problem_FILL0_wght400_GRAD0_opsz48.svg' %}"  style="height: 14pt" alt="Network error!">

        
      {% if perms.UUID.change_blob %}
         <input type="submit" class="btn btn-primary" 
         data-toggle="tooltip" title="Save changes so far, update diff"
         onclick="blob_post('save_no_reload'); return false;"
         id="id_blobeditform_save_no_reload" name="save" value="Save">

         <script>user_can_save = true;</script>

         <input type="submit" class="btn {{ revert_button_class }} float-right" 
         data-toggle="tooltip" title="Revert to previous version"
         onclick="blob_post('revert'); return false;"
         id="id_blobeditform_revert" name="revert" value="Revert">

         <br>
         <div class="border border-info mt-1">
         <input type="submit" class="btn btn-primary" 
         data-toggle="tooltip" title="Normalize LaTeX"
         onclick="blob_post('normalize'); return false;"
         id="id_blobeditform_normalize" name="normalize" value="Normalize">
         
         {% for field in blobeditform %} {% if field.name in blobform_filters %}
           <span class="border m-2 p-2" data-toggle="tooltip" title="{{ field.help_text|safe }}">
             {{ field.errors }}    {{ field.label_tag }} {{ field }}
           </span>  
          {% endif %}
         {% endfor %}

         </div>
      {% endif %}
</form>
<script>
{% if USE_CODEMIRROR and can_change_blob %}
$('a[href="#blob"]').on('shown.bs.tab',activate_BlobEditCodeMirror_once);
{% else %}
 {# non CodeMirror #}
window.addEventListener('load', restore_editform_non_cm );
$('#id_BlobEditTextarea').on('input propertychange change keyup paste', update_blobedit_timestamp );
{% endif %}
</script>
