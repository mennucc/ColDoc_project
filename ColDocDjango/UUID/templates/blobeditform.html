{% load static %}
<script>
var blob_md5="{{blob_md5}}"; var blob_mtime="{{blob_mtime}}";
{% if BLOB %}
  var get_blob_md5_url = "{% url 'UUID:md5' NICK=NICK UUID=UUID FILE=BLOB %}";
{% else %}
  var get_blob_md5_url = "";
{% endif %}
</script>

{% if USE_CODEMIRROR %}
<script> var use_CodeMirror = true; </script>
<link href="{% static 'UUID/cm/lib/codemirror.css' %}" rel="stylesheet">
<style>
      .breakpoints {width: .8em;}
      .breakpoint { color: #822; }
      .CodeMirror {border: 1px solid #aaa;}
      .cm-trailingspace {
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAACCAYAAAB/qH1jAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QUXCToH00Y1UgAAACFJREFUCNdjPMDBUc/AwNDAAAFMTAwMDA0OP34wQgX/AQBYgwYEx4f9lQAAAABJRU5ErkJggg==);
        background-position: bottom left;
        background-repeat: repeat-x;
      }
</style>
    
<script src="{% static 'UUID/cm/lib/codemirror.js' %}"></script>

<script src="{% static 'UUID/cm/addon/edit/matchbrackets.js' %}"></script>
<script src="{% static 'UUID/cm/addon/edit/trailingspace.js' %}"></script>

<script src="{% static 'UUID/cm/mode/stex/stex.js' %}"></script>
<script src="{% static 'UUID/cm/addon/scroll/annotatescrollbar.js' %}"></script>

<script src="{% static 'UUID/cm/addon/scroll/simplescrollbars.js' %}"></script>
<link href="{% static 'UUID/cm/addon/scroll/simplescrollbars.css' %}" rel="stylesheet">

<script src="{% static 'UUID/cm/addon/search/searchcursor.js' %}"></script>

<script src="{% static 'UUID/cm/addon/search/jump-to-line.js' %}"></script>

<script src="{% static 'UUID/cm/addon/search/matchesonscrollbar.js' %}"></script>

<script src="{% static 'UUID/cm/addon/search/search.js' %}"></script>

{% include "CodeMirrorHelp.html" %}

{% else %}
<script> var use_CodeMirror = false; </script>
{% endif %}

<form action="{% url 'UUID:postedit' NICK=NICK UUID=UUID %}" id="{{ blobeditform.htmlid }}" method="post" class="w-100">
        {% csrf_token %}{{ blobeditform.non_field_errors }}
        {% for field in blobeditform %}{% if field.is_hidden %} {{ field }} {% else %}
         <div class="form-group w-100" id="id_div_blobeditform_{{field.name}}"  >
          {{ field.errors }}    {{ field.label_tag }} {{ field }}
          {% if field.help_text %}
            <small class="font-italic">{{ field.help_text|safe }}</small>
          {% endif %}
         </div>
        {% endif %}{% endfor %}
        <input type="submit" class="btn btn-primary"
         data-toggle="tooltip" title="Save changes, update PDF and HTML"
         onclick="update_editform();  if ( check_primary_tab() ) { prevent_unload_remove (); blob_polling =0 ; view_polling =0 ; return true; } else {return false;}"
         id="id_blobeditform_compile" name="compile" value="Compile">
      {% if perms.UUID.change_blob %}
         <input type="submit" class="btn btn-primary" 
         data-toggle="tooltip" title="Save changes so far, update diff"
         onclick="blob_post('save_no_reload'); return false;"
         id="id_blobeditform_save_no_reload" name="save" value="Save">
         
         <input type="submit" class="btn btn-primary" 
         data-toggle="tooltip" title="Normalize LaTeX"
         onclick="blob_post('normalize'); return false;"
         id="id_blobeditform_normalize" name="normalize" value="Normalize">

         <input type="submit" class="btn {{ revert_button_class }} float-right" 
         data-toggle="tooltip" title="Revert to previous version"
         onclick="blob_post('revert'); return false;"
         id="id_blobeditform_revert" name="revert" value="Revert">
      {% endif %}
</form>
<script>
var BlobEditCodeMirror = undefined;
{% if USE_CODEMIRROR %}

function activate_BlobEditCodeMirror(e) {
let textarea = document.getElementById("id_BlobEditTextarea");
BlobEditCodeMirror = CodeMirror.fromTextArea(textarea, {
      mode: "text/x-stex",
      matchBrackets: true,
      extraKeys: {"Alt-F": "findPersistent"},
      lineNumbers:  true,
      showTrailingSpace : true,
      // FIXME gutters: ["CodeMirror-linenumbers", "breakpoints"]
      });
BlobEditCodeMirror.on("change", update_blobedit_timestamp );
};
//
function activate_BlobEditCodeMirror_once(e) {
  if( BlobEditCodeMirror == undefined && e.target.href.includes('#blob')) {
    activate_BlobEditCodeMirror(e);
  }
};
$('a[href="#blob"]').on('shown.bs.tab',activate_BlobEditCodeMirror_once);
{% else %}
$('#id_BlobEditTextarea').on('input propertychange change keyup paste', update_blobedit_timestamp );
{% endif %}
</script>
